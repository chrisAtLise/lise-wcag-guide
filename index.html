<!DOCTYPE html>
<html :lang="lang">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="./assets/tailwind.js"></script>
    <!-- <script src="./node_modules/tailwindcss/dist/chunk-AZANAYY2.mjs"></script> -->
    <!-- <link rel="stylesheet" href="./style.css" /> -->
    <script src="./assets/tailwindstyles.js"></script>
    <title>lise WCAG 2.2 Guide</title>
  </head>
  <body class="bg-darklise text-white">
    <div
      class="md:absolute top-40 md:top-20 w-2/5 md:w-1/5 h-8 flex flex-col items-center"
    >
      <img src="./assets/lise.svg" alt="Logo of lise GmbH" class="" />
    </div>
    <div
      id="app"
      class="container sm:max-w-lg md:max-w-3xl lg:max-w-4xl relative mx-auto mt-32 px-4 sm:px-8 md:px-16"
    >
      <button
        v-if="lang==='de'"
        class="mx-auto block underline cursor-pointer text-lise text-xs"
        @click="lang = 'en'"
      >
        switch to english
      </button>
      <button
        v-else
        class="mx-auto block underline cursor-pointer text-lise text-xs"
        @click="lang = 'de'"
      >
        auf deutsch umschalten
      </button>
      <header
        class="mx-auto my-8 text-white bg-teal-950 p-8 rounded-xl text-left flex flex-col md:flex-row"
      >
        <div class="sm:w-3/4">
          <h1 class="font-bold text-4xl text-center md:text-left">
            WCAG 2.2 Guide
          </h1>
          <p v-if="lang==='de'" class="!text-sm leading-loose mt-4 md:pr-8">
            Ein WCAG Reiseführer entwickelt mit Herzblut von den Mädels und
            Jungs der lise. Diese Dokument basiert auf der

            <a
              class="underline"
              href="https://www.w3.org/TR/2024/REC-WCAG22-20241212/"
              >der WCAG vom 12 December 2024</a
            >
          </p>
          <p v-else class="!text-sm leading-loose mt-4 md:pr-8">
            A hitchhikers guide to WCAG by the girls and boys working at lise.
            This document is based on
            <a
              class="underline"
              href="https://www.w3.org/TR/2024/REC-WCAG22-20241212/"
              >the WCAG from 12 December 2024</a
            >
          </p>
        </div>
        <img
          src="./assets/wcag.svg"
          class="w-32 my-4 mx-auto"
          alt="Logo of wcag 2.2 aaa"
        />
      </header>

      <!-- Filter Sidebar -->

      <aside
        class="transition z-50 ease-in-out transform filter w-full md:w-[300px] mx-auto my-4 text-xs rounded-md px-8 py-4 md:fixed top-0 right-2 shadow-lg shadow-emerald-800/50 bg-teal-950 opacity-95"
        :class="{'translate-x-[80%] h-18 overflow-hidden': asideClose}"
      >
        <div class="flex items-center">
          <button
            aria-label="collapse"
            class="text-lise rounded-sm w-10 h-10 cursor-pointer hover:bg-darklise -ml-4 hidden md:block mr-8"
            @click="asideClose=!asideClose"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              enable-background="new 0 0 24 24"
              height="24px"
              viewBox="0 0 24 24"
              width="24px"
              fill="currentColor"
              class="transform ml-2"
              :class="{'rotate-180': !asideClose}"
            >
              <g><rect fill="none" height="24" width="24" /></g>
              <g>
                <g>
                  <polygon
                    points="17.59,18 19,16.59 14.42,12 19,7.41 17.59,6 11.59,12"
                  />
                  <polygon
                    points="11,18 12.41,16.59 7.83,12 12.41,7.41 11,6 5,12"
                  />
                </g>
              </g>
            </svg>
          </button>
          <h2
            v-if="lang==='de'"
            class="text-base font-bold sm:opacity-60 py-4 md:py-0"
          >
            Einträge eingrenzen
          </h2>
          <h2 v-else class="text-base font-bold sm:opacity-60 py-4 md:py-0">
            Filter the entries
          </h2>
        </div>

        <div class="flex py-4">
          <div class="w-1/4">
            <label class="font-bold">Conformance level</label>
          </div>
          <div class="w-3/4 flex justify-between pl-8">
            <label
              v-for="level in conformanceLevels"
              :key="level"
              class="p-1 flex flex-col items-center w-12 border border-transparent"
              :class="{' border-white rounded-md text-lise':selectedConformanceLevel===level}"
            >
              <input
                type="radio"
                v-model="selectedConformanceLevel"
                :value="level"
              />

              <span class="font-bold text-lg pt-2">{{level}}</span>
            </label>
          </div>
        </div>

        <!-- Tags List -->
        <label v-if="lang==='de'" class="font-bold pb-4"
          >Filtern nach Rolle</label
        >
        <label v-else class="font-bold pb-4">Filter Perspective</label>
        <div class="flex flex wrap">
          <select
            class="bg-darklise p-2 rounded-md w-full mt-2 mb-4"
            v-model="selectedPerspective"
            id="perspective"
          >
            <option
              v-for="perspective in possiblePerspectives"
              :key="perspective.id"
              :value="perspective.name"
            >
              {{perspective.name[lang]}}
            </option>
          </select>
        </div>
        <span
          v-if="selectedPerspectiveDescription && selectedPerspectiveDescription.description"
          >{{selectedPerspectiveDescription.description[lang]}}
        </span>
        <label class="font-bold block pt-4"></label>
        <div
          v-for="filter in filters"
          :key="filter.name"
          class="flex pt-2 h-12 checkbox-container"
        >
          <label v-if="filter.question" class="w-3/4 pr-2 cursor-pointer"
            >{{filter.question[lang]}}
          </label>
          <button
            class="rounded-full w-[50px] bg-darklise p-1 inline-block h-6 relative cursor-pointer"
            :class="{'bg-lise':selectedTags.includes(filter.name),'bg-darklise':!selectedTags.includes(filter.name)}"
            @click="toggleTag(filter.name)"
          >
            <span
              class="toggle"
              :class="{'translate-x-[10px] bg-darklise':selectedTags.includes(filter.name),'-translate-x-[10px] bg-white':!selectedTags.includes(filter.name)}"
            ></span>
          </button>
          <span v-if="lang=='de'" class="w-10 h-6 flex justify-end items-center"
            >{{selectedTags.includes(filter.name)?"Ja":"Nein"}}</span
          >
          <span v-else class="w-10 h-6 flex justify-end items-center"
            >{{selectedTags.includes(filter.name)?"Yes":"No"}}</span
          >

          <hr />
        </div>

        <label class="mt-5 block text-lg">
          <span v-if="lang==='de'"> Angezeigte Einträge: </span>
          <span v-else> Applicable entries: </span>
          <span class="text-lise">{{ filteredContent.length }}</span>
        </label>
      </aside>

      <!-- Filtered Content -->
      <main>
        <section v-for="entry in filteredContent" :key="entry.name[lang]">
          <div class="relative">
            <component :is="`h${entry.level+1}`" class=""
              >{{ entry.name[lang] }}
              <button
                v-if="entry.understanding.length > 5 && showUnderstanding !== entry.name[lang]"
                class="ml-2 inline h-6 w-6 text-sm leading-none bg-emerald-950 hover:bg-emerald-800 hover:text-lise cursor-pointer rounded-full"
                aria-label="more"
                @click="showUnderstanding = entry.name[lang]"
              >
                ?
              </button>
            </component>

            <div v-if="entry.conformance" class="conformance">
              {{ entry.conformance }}
            </div>
          </div>
          <div
            v-if="entry.understanding.length > 5  && showUnderstanding === entry.name[lang]"
            class="infobox"
          >
            <span class="understanding" v-html="entry.understanding"></span>
          </div>
          <template v-for="tag in entry.tags" :key="tag"
            ><span class="tag" v-if="tag && tag.length > 1"
              >{{tag}}</span
            ></template
          >
          <div v-html="entry.content[lang]"></div>
        </section>
      </main>
    </div>
    <script src="./node_modules/vue/dist/vue.global.js"></script>

    <script>
      const { createApp, ref, computed, onMounted, watch } = Vue;

      createApp({
        setup() {
          const lang = ref("en");
          const showUnderstanding = ref("");

          const content = ref([]);
          const possiblePerspectives = ref([]);
          const filters = ref([]);
          onMounted(async () => {
            try {
              const response = await fetch("./data/wcag22_tag_2502121632.json");
              content.value = await response.json();
              cleanUpTags();
              extractTags(); // Extract tags after loading content
              const responsePerspectives = await fetch(
                "./data/perspectives.json"
              );
              possiblePerspectives.value = await responsePerspectives.json();
              const responseFilters = await fetch("./data/filters.json");
              filters.value = await responseFilters.json();
              selectedTags.value = filters.value.map((item) => item.name);
            } catch (error) {
              console.error("Error loading JSON:", error);
            }
          });
          const asideClose = ref(false);
          const selectedTags = ref([]);
          const resetTags = () => {
            selectedTags.value = [];
          };
          const tags = ref([]);
          const selectedConformanceLevel = ref("AAA");
          const conformanceLevels = ["A", "AA", "AAA"];

          const selectedPerspective = ref({
            en: "show all",
            de: "Alle zeigen",
          });
          const selectedPerspectiveDescription = computed(() => {
            if (!selectedPerspective.value) return null;
            // Use find instead of filter to get a single object
            return possiblePerspectives.value.find(
              (perspective) => perspective.name === selectedPerspective.value
            );
          });
          // Extract unique tags
          const extractTags = () => {
            const allTagsSet = new Set();
            content.value.forEach((entry) => {
              if (entry.tags && Array.isArray(entry.tags)) {
                // console.log(entry.tags);
                entry.tags.forEach((tag) =>
                  tag && tag.length > 1 ? allTagsSet.add(tag) : null
                );
              }
            });
            tags.value = Array.from(allTagsSet);
          };
          const cleanUpTags = () => {
            content.value.forEach((entry) => {
              if (entry.tags && Array.isArray(entry.tags)) {
                entry.tags = entry.tags.filter((tag) => tag !== "");
                entry.tags = entry.tags.filter((tag) => tag !== " ");
                entry.tags = entry.tags.filter((tag) => tag !== "-");
                entry.tags = entry.tags.filter((tag) => tag !== null);
                console.log(entry.tags);
              }
            });
          };

          // Toggle tag selection
          const toggleTag = (tag) => {
            if (selectedTags.value.includes(tag)) {
              selectedTags.value = selectedTags.value.filter((t) => t !== tag);
            } else {
              selectedTags.value.push(tag);
            }
          };

          // Compute available tags dynamically
          const allTags = computed(() => tags.value);

          // Compute filtered content
          const filteredContent = computed(() => {
            return (
              content.value
                // Filter Conformance
                .filter((entry) => {
                  // Always show level 1 and 2 entries
                  if (entry.level == 1) {
                    return true;
                  }
                  // Filter by conformance level
                  if (selectedConformanceLevel.value === "A") {
                    return (
                      entry.conformance === "A" || entry.conformance === ""
                    );
                  } else if (selectedConformanceLevel.value === "AA") {
                    return (
                      entry.conformance === "AA" ||
                      entry.conformance === "A" ||
                      entry.conformance === ""
                    );
                  } else if (selectedConformanceLevel.value === "AAA") {
                    return true;
                  }

                  return true;
                })
                // Filter Perspectives
                .filter((entry) => {
                  if (entry.level == 1) {
                    return true;
                  }

                  if (
                    (selectedPerspective.value &&
                      selectedPerspective.value[lang.value] == "Alle zeigen") ||
                    (selectedPerspective.value &&
                      selectedPerspective.value[lang.value] == "show all")
                  ) {
                    return true;
                  }
                  return (
                    entry.perspective &&
                    entry.perspective.some(
                      (per) => selectedPerspective.value[lang.value] === per
                    )
                  );
                })
                .filter((entry) => {
                  if (!selectedTags.value || selectedTags.value.length === 0) {
                    return true; // Keine Tags ausgewählt → Zeige alle Einträge
                  }

                  if (!entry.tags || entry.tags.length === 0) {
                    return true; // Einträge ohne Tags bleiben erhalten
                  }

                  // Prüfen, ob ALLE Tags des Eintrags in selectedTags enthalten sind
                  const allTagsInSelected = entry.tags.every((tag) =>
                    selectedTags.value.includes(tag)
                  );

                  // Falls alle Tags in selectedTags enthalten sind, den Eintrag ignorieren (nicht anzeigen)
                  return !allTagsInSelected;
                })
            );
          });

          // watch(selectedConformanceLevel, (newValue) => {
          //   console.log("Filter changed to:", newValue);
          // });

          // schließe alle aus in denen einer der selectedTags drin vor kommt, aber ncihta anderes
          // für jeden selected tag überprüfe ob der Eintrag

          // ignoriere jeden eintrag der nur 1 tag hat und dieser ist einer der liste in selectedTags

          // ignoriere jeden eintrag der 2 tags hat und diese sind beide in der liste in selected tags
          // ignoriere jeden eintrag der 3 tags hat und diese sind alle 3 in der liste in selected tags
          // ignoriere jeden eintrag der 4 tags hat und diese sind alle 4 in der liste in selected tags

          return {
            content,
            filteredContent,
            selectedConformanceLevel,
            allTags,
            selectedTags,
            toggleTag,
            resetTags,
            asideClose,
            conformanceLevels,
            possiblePerspectives,
            selectedPerspective,
            selectedPerspectiveDescription,
            filters,
            lang,
            showUnderstanding,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
